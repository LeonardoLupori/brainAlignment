# What files do you need?

[⬅ previous](01_imageAcquisition.md)  

> ## Index
>
> - [Input Files](#input-files)
> - [Folders content](#folders-content)
> - [Example of a folder structure](#example-of-a-folder-structure)
> - [Create a mouse folder](#create-a-mouse-folder)

---

This page explains how to arrange the files in a proper folder structure.

> It is best practice that all filenames and folder names
>
> - Contain **no spaces**.  Consider replacing them with underscores `"_"`
> - Follow a consistent naming convention
> - Are as compact and short as possible

## Input files

The pipeline is thought to be applied to a **series of slices** belonging to the same animal.
For the analysis, a set of different files for each slice are necessary. Here is an overview and a brief introduction to all of them.

### Hi-res images

These files are **8-bit**, **single channel**, gray-scale `.tif` images at **full resolution** (typically more than 10000 pixels wide for a whole brain slice). If in your experiment you acquired data for more than one channel, you will have one Hi-res image for each channel. Each image will have a field in the filename specifying which channel it refers to (starting from channel 1), for example `..._C3.tif`.

 All fluorescence quantification will be performed on this set of images

### Thumbnails

These files are **8-bit**, **RGB** `.png` images. All the channels are merged in a single RGB image and drastically **downsampled** in size (typically between 10 and 20% of the original image width). These images can also be **adjusted in brightness** to make biological structures more visible.
They will be used as a quick to load, low-resolution, version of the original images, and all the alignment procedure and mask creation and editing will be done using thumbnails as a reference.

Thumbnails can be generated from the original Hi-res images with a MATLAB script.

Thumbnails have the `-thumb.png` **descriptor** at the end of their filename.

### Masks

These files are **1-bit**, **binary** `.png` images. There is one mask image for each thumbnail image (i.e., one for each experimental slice). Masks are essential to tell the pipeline which are the pixels that must be considered in the analysis process (ones, or white pixels) and which are those that have to be discarded (zeros or black pixels).

Masks will be automatically generated by using the tool [Ilastik](https://www.ilastik.org/) to classify pixels in two classes: 1. pixels belonging to the biological tissue and 2. pixels belonging to the background.

After creation, masks can also be manually edited in order to exclude staining artifacts, areas with damage, or to correct misclassification errors by Ilastik.

Masks have the `-mask.png` **descriptor** at the end of their filename.

### Displacement fields

These files are `.csv` tables. They contain a *displacement field*, that is a map of how much every pixels have to be moved in either the X or the Y axis in order to better match the atlas. These files are the result of the **non-rigid alignment** phase of the pipeline.

There are 2 files for each experimental slice, one for displacements on the X axis and another one for displacement in the Y axis.

To generate displacement fields it is required that you already performed the non-rigid alignment with [VisuAlign](https://www.nitrc.org/projects/visualign/) and saved the result in a `MOUSENAME-visualign.json` file. Starting from this file, X- and Y-displacement fields can be generated for each slice with a MATLAB script.

Displacement fields have the `-dispFieldX.png` or `-dispFieldY.png` **descriptor** at the end of their filename.

### Cell counts

These files are `.csv` tables where each row contains the X,Y coordinates (in pixels) of every cell (also called *dots* here). The first row of the table contains columns titles. columns labeled `x` and `y` must be present in order for the cell position to be recognized.

> Example:
> |x|y|
> |-|-|
> |608|1990|
> |69|420|
> |.|.|
> |.|.|

It's possible to have a count file for **each channel** of the original image.

Cell counts have the `-cells_C1` or `-cells_C2` **descriptor** at the end of their filename (examples for cell counts of items in channel 1 or channel 2).

### Info file

This is a single `.xml` file that contains general information about the mouse and about each slice. It can be loaded as a struct in MATLAB by using the `readstruct()` function.

It contains the following fields:

- mouseID
- treatment
- genotype
- sex
- age
- channelNames
- channelNames
- slices (one for each slice)
  - name
  - number
  - well
  - flipped
  - valid

This file has the name `MOUSENAME-info.xml` filename.

### QuickNII file

This is a single `.xml` file that is generated by MATLAB after running the `xmlBuilderQuickNII` script. This file is the one that you load each time you want to modify or update the global alignment in quickNII.

This file has the name `MOUSENAME-quicknii.xml` filename.

### VisuAlign file

This is a single `.json` file.
This file is first generated by quickNII at the end of the procedure of global alignment, by clicking the button to save json. After you generated it, you can open this file in VisuAlign in order to perform non rigid local registration on each slice.

This file has the name `MOUSENAME-visualign.json` filename.

## Folders content

- All the experimental data must be contained in a folder named `DATASET`
- The folder `DATASET` contains one subfolder for each mouse. The name of each subfolder is an unique identifier of the mouse (e.g., `MOUSENAME`).
- Each mouse folder is a unique and independent unit and each one of them will contain the following subfolder structure:
  - **counts**: Contains `.csv` files (one for each channel) with the x and y positions of each counted cell in that channel for each slice
  - **dispFields**: Contains `.csv` files (one for the X axis and another for the Y axis) with the downsampled X and Y displacement fields for each slice
  - **hiRes**: Contains `.tif` files (one for each channel) with the high-resolution, original images
  - **masks**: Contains 1-bit `.png` files with a logical mask for each slice
  - **thumbnails**: Contains 8-bit RGB `.png` files that are a lower resolution and RGB version of the original images, used to compute masks and align to the reference atlas.

  Each mouse folder also contains 3 files:
  - **info file**: A `.xml` file (e.g., `MOUSENAME-info.xml`) with information on the mouse and on each experimental slice
  - **quickNII file**: A `.xml` file (e.g., `MOUSENAME-quicknii.xml`) with details on the global alignment of each slice. This file is the output of QuickNII.
  - **visualign file**: A `.json` file (e.g, `MOUSENAME-visualign.json`) with details on the non-rigid image registration for each slice. This file is the output of VisuAlign.

## Example of a folder structure

This is an example of a folder structure for an experiment with 2-channels images and cell counts. Here the Mouse ID is referred to as `MOUSENAME1`.

```
DATASET/
  |
  |
  |-- MOUSENAME1/
  |     |
  |     |-- counts/
  |     |     |-- MOUSENAME1_001-cells_C1.csv
  |     |     |-- MOUSENAME1_001-cells_C2.csv
  |     |     |-- MOUSENAME1_004-cells_C1.csv
  |     |     .
  |     |     .
  |     |
  |     |-- dispFields/
  |     |     |-- MOUSENAME1_001-dispFieldX.csv
  |     |     |-- MOUSENAME1_001-dispFieldY.csv
  |     |     |-- MOUSENAME1_004-dispFieldX.csv
  |     |     .
  |     |     .
  |     |-- hiRes/
  |     |     |-- MOUSENAME1_001-C1.tif
  |     |     |-- MOUSENAME1_001-C2.tif
  |     |     |-- MOUSENAME1_004-C1.tif
  |     |     .
  |     |     .
  |     |-- masks/
  |     |     |-- MOUSENAME1_001-mask.png
  |     |     |-- MOUSENAME1_004-mask.png
  |     |     .
  |     |     .
  |     |-- thumbnails/
  |     |     |-- MOUSENAME1_001-thumb.png
  |     |     |-- MOUSENAME1_004-thumb.png
  |     |     .
  |     |     .
  |     |
  |     |-- MOUSENAME1-info.xml
  |     |-- MOUSENAME1-quicknii.xml
  |     |-- MOUSENAME1-visualign.json
  |
  |-- MOUSENAME2/
  |     |
  .     .
  .     .
  .     .
```

## Create a mouse folder

Before creating a mouse folder make sure that  

1. You have exported all the RGB high resolution `.tiff` images for a mouse in a temporary folder.  
2. You renamed images with the naming convention specified above (e.g., `CC1A_005_D4.tif`)

The creation of the folder and subfolder for a mouse is automatized by running the `prepareMouseFolder.m` MATLAB script. This file is a multi-cell MATLAB script that should be executed cell-by-cell.

This script will guide you through several steps.

### 1. Image mirroring

Often, brain slices are not cut perfectly coronal. This means that one hemisphere is going to be more posterior that the other. To facilitate all the alignment steps it's best to vertically mirror the images in order to have the most posterior part always on the same side.

To do this you need to:

1. Run the appropriate cells in the `P1_prepareMouseFolder.m` MATLAB script to generate the flipInfo excel file for this animal.
2. Open the flipInfo file and manually annotate for each slice whether the most posterior side is the left (l) or right (r)
3. Run the appropriate cells in the `P1_prepareMouseFolder.m` MATLAB script to automatically flip the correct subset of images.

### 2. Create and populate folders

In the last cell the script will create all the appropriate folder structure for you and will populate it with automatically generated **thumbnails** and **hiRes** images split by channel.

[next ➡](03_preprocessing.md)

---

*Leonardo Lupori and Valentino Totaro*
